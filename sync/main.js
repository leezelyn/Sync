(()=>{"use strict";let e;var t={},n={};function o(e){var i=n[e];if(void 0!==i)return i.exports;var r=n[e]={exports:{}};return t[e](r,r.exports,o),r.exports}function i(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.config)?void 0:t.readConfig))return JSON.parse(globalThis.AstroBox.config.readConfig());throw Error("AstroBox.config.readConfig not available on native side")}function r(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.config)?void 0:n.writeConfig))globalThis.AstroBox.config.writeConfig(JSON.stringify(e));else throw Error("AstroBox.config.writeConfig not available on native side")}function a(e){let t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",o,i=e.length;for(o=2;o<i;o+=3)n+=t[e[o-2]>>2],n+=t[(3&e[o-2])<<4|e[o-1]>>4],n+=t[(15&e[o-1])<<2|e[o]>>6],n+=t[63&e[o]];return o===i+1&&(n+=t[e[o-2]>>2],n+=t[(3&e[o-2])<<4],n+="=="),o===i&&(n+=t[e[o-2]>>2],n+=t[(3&e[o-2])<<4|e[o-1]>>4],n+=t[(15&e[o-1])<<2],n+="="),n}function l(e){if((e=e.replace(/[\r\n\s]/g,"")).length%4!=0)throw Error("Invalid base64 string length");let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=0;e.endsWith("==")?n=2:e.endsWith("=")&&(n=1);let o=e.length/4*3-n,i=new Uint8Array(o),r=0;for(let n=0;n<e.length;n+=4){let a=t.indexOf(e[n])<<18|t.indexOf(e[n+1])<<12|t.indexOf(e[n+2])<<6|t.indexOf(e[n+3]);r<o&&(i[r++]=a>>16&255),r<o&&(i[r++]=a>>8&255),r<o&&(i[r++]=255&a)}return i}async function s(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.debug)?void 0:n.sendRaw))await globalThis.AstroBox.debug.sendRaw(a(e));else throw Error("AstroBox.debug.sendRaw not available on native side")}function c(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.device)?void 0:t.getDeviceList))return JSON.parse(globalThis.AstroBox.device.getDeviceList());throw Error("AstroBox.device.getDeviceList not available on native side")}function u(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.device)?void 0:n.getDeviceState))return JSON.parse(globalThis.AstroBox.device.getDeviceState(e));throw Error("AstroBox.device.getDeviceState not available on native side")}function f(e,t){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.device)?void 0:o.modifyDeviceState))globalThis.AstroBox.device.modifyDeviceState(e,JSON.stringify(t));else throw Error("AstroBox.device.modifyDeviceState not available on native side")}async function d(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.device)?void 0:t.disconnectDevice))await globalThis.AstroBox.device.disconnectDevice();else throw Error("AstroBox.device.disconnectDevice not available on native side")}function v(e,t){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.event)?void 0:o.addEventListener))globalThis.AstroBox.event.addEventListener(e,t);else throw Error("AstroBox.event.addEventListener not available")}function g(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.event)?void 0:n.removeEventListener))globalThis.AstroBox.event.removeEventListener(e);else throw Error("AstroBox.event.removeEventListener not available")}function y(e,t){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.event)?void 0:o.sendEvent))globalThis.AstroBox.event.sendEvent(e,t);else throw Error("AstroBox.event.sendEvent not available")}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),o.forEach(function(t){var o;o=n[t],t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o})}return e}async function p(e){var t,n;let o=h({decode_text:!1,encoding:"undefined"},e);if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.filesystem)?void 0:n.pickFile))return JSON.parse(await globalThis.AstroBox.filesystem.pickFile(JSON.stringify(o)));throw Error("AstroBox.filesystem.pickFile not available")}async function b(e,t){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.filesystem)?void 0:o.readFile)){let n=h({offset:0,decode_text:!0},t);var i=await globalThis.AstroBox.filesystem.readFile(e,JSON.stringify(n));return n.decode_text?i:l(i)}throw Error("AstroBox.filesystem.readFile not available")}async function A(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.filesystem)?void 0:n.unloadFile))return await globalThis.AstroBox.filesystem.unloadFile(e);throw Error("AstroBox.filesystem.unloadFile not available")}function x(e,t){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.installer)?void 0:o[e]))globalThis.AstroBox.installer[e](t);else throw Error("AstroBox.installer.".concat(e," not available"))}o.rv=()=>"1.4.10",o.ruid="bundler=rspack@1.4.10";let m=e=>x("addThirdPartyAppToQueue",e),w=e=>x("addWatchFaceToQueue",e),B=e=>x("addFirmwareToQueue",e);async function T(e,t){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.interconnect)?void 0:o.sendQAICMessage))await globalThis.AstroBox.interconnect.sendQAICMessage(e,t);else throw Error("AstroBox.interconnect.sendQAICMessage not available")}function S(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.lifecycle)?void 0:n.onLoad))globalThis.AstroBox.lifecycle.onLoad(e);else throw Error("AstroBox.lifecycle.onLoad not available")}function O(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.native)?void 0:n.regNativeFun))return globalThis.AstroBox.native.regNativeFun(e);throw Error("AstroBox.native.regNativeFun not available")}async function E(e,t){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.network)?void 0:o.fetch)){t.body_encoded="string"!=typeof t.body,t.body=t.body?t.body_encoded?a(t.body):t.body:"";let n=await globalThis.AstroBox.network.fetch(e,JSON.stringify(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),o.forEach(function(t){var o;o=n[t],t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o})}return e}({raw:!1},t)));return n.body=t.raw?l(n.body):n.body,n}throw Error("AstroBox.network.fetch not available")}async function C(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.provider)?void 0:n.registerCommunityProvider))await globalThis.AstroBox.provider.registerCommunityProvider(JSON.stringify(e));else throw Error("AstroBox.provider.registerCommunityProvider not available")}async function N(e,t){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.thirdpartyapp)?void 0:o.launchQA))await globalThis.AstroBox.thirdpartyapp.launchQA(JSON.stringify(e),t);else throw Error("AstroBox.thirdpartyapp.launchQA not available")}async function F(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.thirdpartyapp)?void 0:t.getThirdPartyAppList))return JSON.parse(await globalThis.AstroBox.thirdpartyapp.getThirdPartyAppList());throw Error("AstroBox.thirdpartyapp.getThirdPartyAppList not available")}function P(e,t){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.ui)?void 0:o[e]))globalThis.AstroBox.ui[e](t);else throw Error("AstroBox.ui.".concat(e," not available"))}let L=e=>P("updatePluginSettingsUI",JSON.stringify(e)),k=e=>P("openPageWithNodes",JSON.stringify(e)),U=e=>P("openPageWithUrl",e),D={};!function(e){e.config={},e.config.readConfig=i,e.config.writeConfig=r,e.debug={},e.debug.sendRaw=s,e.device={},e.device.getDeviceList=c,e.device.getDeviceState=u,e.device.modifyDeviceState=f,e.device.disconnectDevice=d,e.event={},e.event.addEventListener=v,e.event.removeEventListener=g,e.event.sendEvent=y,e.installer={},e.installer.addThirdPartyAppToQueue=m,e.installer.addWatchFaceToQueue=w,e.installer.addFirmwareToQueue=B,e.interconnect={},e.interconnect.sendQAICMessage=T,e.lifecycle={},e.lifecycle.onLoad=S,e.native={},e.native.regNativeFun=O,e.network={},e.network.fetch=E,e.provider={},e.provider.registerCommunityProvider=C,e.thirdpartyapp={},e.thirdpartyapp.launchQA=N,e.thirdpartyapp.getThirdPartyAppList=F,e.ui={},e.ui.updatePluginSettingsUI=L,e.ui.openPageWithNodes=k,e.ui.openPageWithUrl=U,e.filesystem={},e.filesystem.pickFile=p,e.filesystem.readFile=b,e.filesystem.unloadFile=A}(D);let J=0,Q=0,M="com.tse.watch.jlpt",I=!1,_=null,j=0,W=null,K="",R=D.native.regNativeFun(q),z=D.native.regNativeFun(G);async function V(){D.event.addEventListener("onQAICMessage_".concat(M),e=>{H(e)})}async function q(){try{let e=await D.filesystem.pickFile({decode_text:!0,encoding:"utf-8"});if(eo(),!e)return void Z("已取消选择");let t=e.path||e.filePath||e.uri||"";if(!t)return void Z("选择到的文件没有路径信息");if(!/\.txt$/i.test(t))return void Z("仅支持选择 .txt 文件");let n=await D.filesystem.readFile(t,{len:e.text_len}),o=await ei(n),i=function(e){let t=String(e).replace(/\r\n?/g,"\n").split("\n"),n=[],o=new Map;for(let e of t){var i,r,a,l,s;if(!e)continue;let t=e.replace(/\uFEFF/g,"").split("	");if(t.length<6)continue;let c=(null!=(i=t[0])?i:"").trim(),u=(null!=(r=t[1])?r:"").trim(),f=(null!=(a=t[2])?a:"").trim(),d=(null!=(l=t[3])?l:"").trim(),v=(null!=(s=t[4])?s:"").trim(),g=t.slice(5).join("	").trim(),y=n.length;n.push({unitNum:c,word:u,kanji:f,tone:d,explain:v,eg:g}),o.has(c)?o.get(c).count++:o.set(c,{firstIndex:y,count:1})}let c=n.length>>>0,u=Array.from(o.keys()).sort((e,t)=>Number(e)-Number(t)),f=u.length>>>0,d=[],v=Array(c),g=Array(c),y=0;for(let e=0;e<c;e++){let t=n[e],o=function(e){let t=[];for(let n=0;n<e.length;n++){let o=e.charCodeAt(n);if(o>=55296&&o<=56319&&n+1<e.length){let t=e.charCodeAt(n+1);t>=56320&&t<=57343&&(o=(o-55296<<10)+(t-56320)+65536,n++)}o<=127?t.push(o):(o<=2047?t.push(192|o>>6):(o<=65535?t.push(224|o>>12):(t.push(240|o>>18),t.push(128|o>>12&63)),t.push(128|o>>6&63)),t.push(128|63&o))}return Uint8Array.from(t)}("".concat(t.unitNum,"&").concat(t.word,"&").concat(t.kanji,"&").concat(t.tone,"&").concat(t.explain,"&").concat(t.eg,"\n"));v[e]=y>>>0,g[e]=o.length>>>0,y+=o.length,d.push(o)}let h=8+(2+10*f),p=12*c,b=new ArrayBuffer(h+p+y),A=new DataView(b),x=0;for(let e of(A.setUint32(x,c,!0),x+=4,A.setUint32(x,h>>>0,!0),x+=4,A.setUint16(x,f,!0),x+=2,u)){let t=Number(e)>>>0,{firstIndex:n,count:i}=o.get(e);A.setUint16(x,t,!0),x+=2,A.setUint32(x,i>>>0,!0),x+=4,A.setUint32(x,n>>>0,!0),x+=4}for(let e=0;e<c;e++)A.setUint32(x,v[e]>>>0,!0),x+=4,A.setUint32(x,g[e]>>>0,!0),x+=4,A.setUint32(x,0,!0),x+=4;let m=new Uint8Array(b);for(let e of d)m.set(e,x),x+=e.length;return m}(o);W=i,J=i.byteLength>>>0,K=$(t).replace(/\.txt$/i,".bin"),Z("已从 ".concat($(t)," 构建").concat(K,"，大小 ").concat(ee(J)," MB"))}catch(e){Z("选择文件失败: ".concat(function(e){try{if(null==e)return"未知错误(null/undefined)";if("string"==typeof e)return e;if(e.message)return e.message;if(e.msg)return e.msg;if(e.errMsg)return e.errMsg;return JSON.stringify(e)}catch(t){return String(e)}}(e)))}}async function G(){if(!(await D.thirdpartyapp.getThirdPartyAppList()).find(e=>e.package_name===M))return void Z("未检测到 ".concat(M));if(!W)return void Z("请先选择 .txt（自动编译）");if(I)return void Z("正在传输中，请勿重复点击");I=!0,j=0,Q=0;try{await X(),Z("已发送 meta，等待手环 ACK…")}catch(e){I=!1,Z("sendMeta 失败：".concat(e.message))}}async function H(e){try{let t=JSON.parse(e);switch(t.cmd){case"ack":en(),j=0,(Q=t.offset>>>0)<J?(await Y(Q),Z("已发送 ".concat(ee(Q),"/").concat(ee(J)," MB"))):await D.interconnect.sendQAICMessage(M,JSON.stringify({cmd:"done"}));break;case"done":en(),Z("传输成功！手环已确认。"),eo();break;default:Z("收到未知命令: ".concat(t.cmd))}}catch(e){Z("解析 ACK 失败：".concat(e.message))}}async function X(){let e=JSON.stringify({cmd:"meta",size:J});await D.interconnect.sendQAICMessage(M,e),et()}async function Y(e){let t=Math.min(4096,J-e),n=W.subarray(e,e+t),o=JSON.stringify({cmd:"chunk",offset:e>>>0,total:J>>>0,data:Array.from(n)});await D.interconnect.sendQAICMessage(M,o),et()}function Z(t){e[2].content.value=t,D.ui.updatePluginSettingsUI(e)}function $(e){return e&&e.replace(/\\/g,"/").split("/").pop()||""}function ee(e){return(e/1024/1024).toFixed(2)}function et(){en(),_=setTimeout(async()=>{if(I)if(j<3){j++,Z("未收到 ACK，重试第 ".concat(j," 次…"));try{await X()}catch(e){Z("重发 meta 失败：".concat(e.message)),I=!1}}else Z("多次重试仍未收到 ACK，传输失败"),I=!1},3e3)}function en(){_&&(clearTimeout(_),_=null)}function eo(){I=!1,J=0,Q=0,W=null,K="",en(),j=0}async function ei(e){return"string"==typeof e?e:e&&"string"==typeof e.text?e.text:e&&e.buffer instanceof ArrayBuffer?er(new Uint8Array(e.buffer,e.byteOffset||0,e.byteLength||e.buffer.byteLength)):e instanceof Uint8Array?er(e):String(null!=e?e:"")}function er(e){let t="",n=e.length;for(let o=0;o<n;o++){let i=e[o];if(i<128){t+=String.fromCharCode(i);continue}if((224&i)==192&&o+1<n){t+=String.fromCharCode((31&i)<<6|63&e[++o]);continue}if((240&i)==224&&o+2<n){t+=String.fromCharCode((15&i)<<12|(63&e[++o])<<6|63&e[++o]);continue}if((248&i)==240&&o+3<n){let n=e[++o],r=(7&i)<<18|(63&n)<<12|(63&e[++o])<<6|63&e[++o];r-=65536,t+=String.fromCharCode(55296+(r>>10)),t+=String.fromCharCode(56320+(1023&r));continue}t+="�"}return t}D.lifecycle.onLoad(()=>{e=[{node_id:"pickBtn",visibility:!0,disabled:!1,content:{type:"Button",value:{primary:!0,text:"选择 .txt 文件",callback_fun_id:R}}},{node_id:"sendBtn",visibility:!0,disabled:!1,content:{type:"Button",value:{primary:!0,text:"发送文件",callback_fun_id:z}}},{node_id:"status",visibility:!0,disabled:!1,content:{type:"Text",value:"就绪，可发送"}}],D.ui.updatePluginSettingsUI(e),V()})})();
//# sourceMappingURL=main.js.map