(()=>{"use strict";let t;var e={},n={};function o(t){var i=n[t];if(void 0!==i)return i.exports;var r=n[t]={exports:{}};return e[t](r,r.exports,o),r.exports}function i(){var t,e;if("function"==typeof(null==(e=null==(t=globalThis.AstroBox)?void 0:t.config)?void 0:e.readConfig))return JSON.parse(globalThis.AstroBox.config.readConfig());throw Error("AstroBox.config.readConfig not available on native side")}function r(t){var e,n;if("function"==typeof(null==(n=null==(e=globalThis.AstroBox)?void 0:e.config)?void 0:n.writeConfig))globalThis.AstroBox.config.writeConfig(JSON.stringify(t));else throw Error("AstroBox.config.writeConfig not available on native side")}function a(t){let e=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",o,i=t.length;for(o=2;o<i;o+=3)n+=e[t[o-2]>>2],n+=e[(3&t[o-2])<<4|t[o-1]>>4],n+=e[(15&t[o-1])<<2|t[o]>>6],n+=e[63&t[o]];return o===i+1&&(n+=e[t[o-2]>>2],n+=e[(3&t[o-2])<<4],n+="=="),o===i&&(n+=e[t[o-2]>>2],n+=e[(3&t[o-2])<<4|t[o-1]>>4],n+=e[(15&t[o-1])<<2],n+="="),n}function l(t){if((t=t.replace(/[\r\n\s]/g,"")).length%4!=0)throw Error("Invalid base64 string length");let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=0;t.endsWith("==")?n=2:t.endsWith("=")&&(n=1);let o=t.length/4*3-n,i=new Uint8Array(o),r=0;for(let n=0;n<t.length;n+=4){let a=e.indexOf(t[n])<<18|e.indexOf(t[n+1])<<12|e.indexOf(t[n+2])<<6|e.indexOf(t[n+3]);r<o&&(i[r++]=a>>16&255),r<o&&(i[r++]=a>>8&255),r<o&&(i[r++]=255&a)}return i}async function s(t){var e,n;if("function"==typeof(null==(n=null==(e=globalThis.AstroBox)?void 0:e.debug)?void 0:n.sendRaw))await globalThis.AstroBox.debug.sendRaw(a(t));else throw Error("AstroBox.debug.sendRaw not available on native side")}function c(){var t,e;if("function"==typeof(null==(e=null==(t=globalThis.AstroBox)?void 0:t.device)?void 0:e.getDeviceList))return JSON.parse(globalThis.AstroBox.device.getDeviceList());throw Error("AstroBox.device.getDeviceList not available on native side")}function u(t){var e,n;if("function"==typeof(null==(n=null==(e=globalThis.AstroBox)?void 0:e.device)?void 0:n.getDeviceState))return JSON.parse(globalThis.AstroBox.device.getDeviceState(t));throw Error("AstroBox.device.getDeviceState not available on native side")}function f(t,e){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.device)?void 0:o.modifyDeviceState))globalThis.AstroBox.device.modifyDeviceState(t,JSON.stringify(e));else throw Error("AstroBox.device.modifyDeviceState not available on native side")}async function d(){var t,e;if("function"==typeof(null==(e=null==(t=globalThis.AstroBox)?void 0:t.device)?void 0:e.disconnectDevice))await globalThis.AstroBox.device.disconnectDevice();else throw Error("AstroBox.device.disconnectDevice not available on native side")}function v(t,e){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.event)?void 0:o.addEventListener))globalThis.AstroBox.event.addEventListener(t,e);else throw Error("AstroBox.event.addEventListener not available")}function g(t){var e,n;if("function"==typeof(null==(n=null==(e=globalThis.AstroBox)?void 0:e.event)?void 0:n.removeEventListener))globalThis.AstroBox.event.removeEventListener(t);else throw Error("AstroBox.event.removeEventListener not available")}function h(t,e){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.event)?void 0:o.sendEvent))globalThis.AstroBox.event.sendEvent(t,e);else throw Error("AstroBox.event.sendEvent not available")}function y(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),o.forEach(function(e){var o;o=n[e],e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o})}return t}async function p(t){var e,n;let o=y({decode_text:!1,encoding:"undefined"},t);if("function"==typeof(null==(n=null==(e=globalThis.AstroBox)?void 0:e.filesystem)?void 0:n.pickFile))return JSON.parse(await globalThis.AstroBox.filesystem.pickFile(JSON.stringify(o)));throw Error("AstroBox.filesystem.pickFile not available")}async function b(t,e){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.filesystem)?void 0:o.readFile)){let n=y({offset:0,decode_text:!0},e);var i=await globalThis.AstroBox.filesystem.readFile(t,JSON.stringify(n));return n.decode_text?i:l(i)}throw Error("AstroBox.filesystem.readFile not available")}async function x(t){var e,n;if("function"==typeof(null==(n=null==(e=globalThis.AstroBox)?void 0:e.filesystem)?void 0:n.unloadFile))return await globalThis.AstroBox.filesystem.unloadFile(t);throw Error("AstroBox.filesystem.unloadFile not available")}function A(t,e){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.installer)?void 0:o[t]))globalThis.AstroBox.installer[t](e);else throw Error("AstroBox.installer.".concat(t," not available"))}o.rv=()=>"1.4.10",o.ruid="bundler=rspack@1.4.10";let m=t=>A("addThirdPartyAppToQueue",t),w=t=>A("addWatchFaceToQueue",t),B=t=>A("addFirmwareToQueue",t);async function T(t,e){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.interconnect)?void 0:o.sendQAICMessage))await globalThis.AstroBox.interconnect.sendQAICMessage(t,e);else throw Error("AstroBox.interconnect.sendQAICMessage not available")}function N(t){var e,n;if("function"==typeof(null==(n=null==(e=globalThis.AstroBox)?void 0:e.lifecycle)?void 0:n.onLoad))globalThis.AstroBox.lifecycle.onLoad(t);else throw Error("AstroBox.lifecycle.onLoad not available")}function S(t){var e,n;if("function"==typeof(null==(n=null==(e=globalThis.AstroBox)?void 0:e.native)?void 0:n.regNativeFun))return globalThis.AstroBox.native.regNativeFun(t);throw Error("AstroBox.native.regNativeFun not available")}async function E(t,e){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.network)?void 0:o.fetch)){e.body_encoded="string"!=typeof e.body,e.body=e.body?e.body_encoded?a(e.body):e.body:"";let n=await globalThis.AstroBox.network.fetch(t,JSON.stringify(function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),o.forEach(function(e){var o;o=n[e],e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o})}return t}({raw:!1},e)));return n.body=e.raw?l(n.body):n.body,n}throw Error("AstroBox.network.fetch not available")}async function O(t){var e,n;if("function"==typeof(null==(n=null==(e=globalThis.AstroBox)?void 0:e.provider)?void 0:n.registerCommunityProvider))await globalThis.AstroBox.provider.registerCommunityProvider(JSON.stringify(t));else throw Error("AstroBox.provider.registerCommunityProvider not available")}async function C(t,e){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.thirdpartyapp)?void 0:o.launchQA))await globalThis.AstroBox.thirdpartyapp.launchQA(JSON.stringify(t),e);else throw Error("AstroBox.thirdpartyapp.launchQA not available")}async function F(){var t,e;if("function"==typeof(null==(e=null==(t=globalThis.AstroBox)?void 0:t.thirdpartyapp)?void 0:e.getThirdPartyAppList))return JSON.parse(await globalThis.AstroBox.thirdpartyapp.getThirdPartyAppList());throw Error("AstroBox.thirdpartyapp.getThirdPartyAppList not available")}function P(t,e){var n,o;if("function"==typeof(null==(o=null==(n=globalThis.AstroBox)?void 0:n.ui)?void 0:o[t]))globalThis.AstroBox.ui[t](e);else throw Error("AstroBox.ui.".concat(t," not available"))}let L=t=>P("updatePluginSettingsUI",JSON.stringify(t)),k=t=>P("openPageWithNodes",JSON.stringify(t)),D=t=>P("openPageWithUrl",t),M={};!function(t){t.config={},t.config.readConfig=i,t.config.writeConfig=r,t.debug={},t.debug.sendRaw=s,t.device={},t.device.getDeviceList=c,t.device.getDeviceState=u,t.device.modifyDeviceState=f,t.device.disconnectDevice=d,t.event={},t.event.addEventListener=v,t.event.removeEventListener=g,t.event.sendEvent=h,t.installer={},t.installer.addThirdPartyAppToQueue=m,t.installer.addWatchFaceToQueue=w,t.installer.addFirmwareToQueue=B,t.interconnect={},t.interconnect.sendQAICMessage=T,t.lifecycle={},t.lifecycle.onLoad=N,t.native={},t.native.regNativeFun=S,t.network={},t.network.fetch=E,t.provider={},t.provider.registerCommunityProvider=O,t.thirdpartyapp={},t.thirdpartyapp.launchQA=C,t.thirdpartyapp.getThirdPartyAppList=F,t.ui={},t.ui.updatePluginSettingsUI=L,t.ui.openPageWithNodes=k,t.ui.openPageWithUrl=D,t.filesystem={},t.filesystem.pickFile=p,t.filesystem.readFile=b,t.filesystem.unloadFile=x}(M);let U="com.tse.watch.jlpt",J=4096,Q=0,_=!1,I=null,j=0,K=null,W="",R=0,z=0,V=0,q=0,G=null,H=M.native.regNativeFun($),X=M.native.regNativeFun(te);function Y(e,n){let o=t.findIndex(t=>t.node_id===e);-1!==o?t[o].content.value=n:t.push({node_id:e,visibility:!0,disabled:!1,content:{type:"Text",value:n}}),M.ui.updatePluginSettingsUI(t)}async function Z(){M.event.addEventListener("onQAICMessage_".concat(U),t=>{tn(t)})}async function $(){try{let t=await M.filesystem.pickFile({decode_text:!0,encoding:"utf-8"});if(ts(),!t)return Y("status","已取消选择");let e=t.path||t.filePath||t.uri||"";if(!/\.txt$/i.test(e))return Y("status","仅支持选择 .txt 文件");let n=(t.size||t.text_len||0)>>>0;if(!n)return Y("status","读取失败：文件长度为 0");let o=await tt(e,n,4096,t=>{Y("status","读取中… ".concat((t/1024).toFixed(1),"/").concat((n/1024).toFixed(1)," KB"))});Y("status","请勿操作，正在编译...");let i=function(t){let e="";for(let n=0;n<t.length;n++){let o=t[n];if(o<128){e+=String.fromCharCode(o);continue}if((224&o)==192&&n+1<t.length){e+=String.fromCharCode((31&o)<<6|63&t[++n]);continue}if((240&o)==224&&n+2<t.length){let i=t[++n];e+=String.fromCharCode((15&o)<<12|(63&i)<<6|63&t[++n]);continue}if((248&o)==240&&n+3<t.length){let i=t[++n],r=t[++n],a=(7&o)<<18|(63&i)<<12|(63&r)<<6|63&t[++n];a-=65536,e+=String.fromCharCode(55296+(a>>10)),e+=String.fromCharCode(56320+(1023&a));continue}e+="�"}return e}(o);Q=(K=function(t){let e=String(t).replace(/\r\n?/g,"\n").split("\n"),n=[];for(let t of e){var o,i,r,a,l;if(!t)continue;let e=t.replace(/^\uFEFF/,"").replace(/\u00A0/g," ").replace(/\u3000/g," ").split("	");if(e.length<6)continue;let s=(null!=(o=e[1])?o:"").trim(),c=(null!=(i=e[2])?i:"").trim(),u=(null!=(r=e[3])?r:"").trim(),f=(null!=(a=e[4])?a:"").trim(),d=(null!=(l=e[5])?l:"").trim(),v=e.slice(6).join("	").trim();n.push({unitNum:s,word:c,kanji:u,tone:f,explain:d,eg:v})}let s=n.slice().sort((t,e)=>Number(t.unitNum)-Number(e.unitNum)),c=s.length>>>0,u=new Map,f=null;for(let t=0;t<s.length;t++){let e=s[t].unitNum;e!==f?(u.set(e,{firstIndex:t,count:1}),f=e):u.get(e).count++}let d=Array.from(u.keys()).sort((t,e)=>Number(t)-Number(e)),v=d.length>>>0,g=[],h=Array(c),y=Array(c),p=0;for(let t=0;t<c;t++){let e=s[t],n=tc("".concat(e.unitNum,"&").concat(e.word,"&").concat(e.kanji,"&").concat(e.tone,"&").concat(e.explain,"&").concat(e.eg,"\n"));h[t]=p>>>0,y[t]=n.length>>>0,p+=n.length,g.push(n)}let b=8+(2+10*v),x=12*c,A=new ArrayBuffer(b+x+p),m=new DataView(A),w=0;for(let t of(m.setUint32(w,c,!0),w+=4,m.setUint32(w,b>>>0,!0),w+=4,m.setUint16(w,v,!0),w+=2,d)){let e=Number(t)>>>0,{firstIndex:n,count:o}=u.get(t);m.setUint16(w,e,!0),w+=2,m.setUint32(w,o>>>0,!0),w+=4,m.setUint32(w,n>>>0,!0),w+=4}for(let t=0;t<c;t++)m.setUint32(w,h[t]>>>0,!0),w+=4,m.setUint32(w,y[t]>>>0,!0),w+=4,m.setUint32(w,0,!0),w+=4;let B=new Uint8Array(A);for(let t of g)B.set(t,w),w+=t.length;return B}(i)).byteLength>>>0,W=((e||"").replace(/\\/g,"/").split("/").pop()||"").replace(/\.txt$/i,".bin"),Y("status","构建完成：".concat(W," ").concat((Q/1024/1024).toFixed(2)," MB"))}catch(t){Y("status","选择失败：".concat(function(t){try{if(null==t)return"未知错误";if("string"==typeof t)return t;if(t.message)return t.message;if(t.msg)return t.msg;if(t.errMsg)return t.errMsg;return JSON.stringify(t)}catch(e){return String(t)}}(t)))}}async function tt(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4096,o=arguments.length>3?arguments[3]:void 0,i=[],r=0;for(;r<e;){var a;let l=Math.min(n,e-r),s=(a=await M.filesystem.readFile(t,{offset:r,len:l,decode_text:!1}))?a instanceof Uint8Array?a:a.buffer instanceof ArrayBuffer?new Uint8Array(a.buffer,a.byteOffset||0,a.byteLength||a.buffer.byteLength):"string"==typeof a?tc(a):new Uint8Array(0):new Uint8Array(0);if(!s.length)throw Error("分片读取返回 0 字节 @".concat(r));i.push(s),r+=s.length,o&&o(r,e)}let l=new Uint8Array(i.reduce((t,e)=>t+e.length,0)),s=0;for(let t of i)l.set(t,s),s+=t.length;return l}async function te(){if(!(await M.thirdpartyapp.getThirdPartyAppList()).find(t=>t.package_name===U))return Y("status","未检测到 ".concat(U));if(!K)return Y("status","请先选择 .txt（自动编译）");if(_)return Y("status","正在传输中…");_=!0,j=0,R=z=q=Date.now(),V=0;try{await to(),Y("status","已发送 meta，等待 ACK…")}catch(t){_=!1,Y("status","sendMeta 失败：".concat(t.message))}}async function tn(t){try{let e=JSON.parse(t);switch(e.cmd){case"ack":{tl(),j=0;let t=e.offset>>>0;if(t>V){let e=Date.now(),n=Math.max(.001,(e-z)/1e3),o=((t-V)/1024/n).toFixed(1),i=(t/1024/Math.max(.001,(e-R)/1e3)).toFixed(1);z=e,V=t,Y("status","已发 ".concat((t/1024).toFixed(1),"/").concat((Q/1024).toFixed(1)," KB | ").concat(o," KB/s | 均速 ").concat(i," KB/s"))}t<Q?await tr(t):await M.interconnect.sendQAICMessage(U,JSON.stringify({cmd:"done"}));break}case"done":tl(),Y("status","传输成功！"),ts();break;case"resend":tl(),await tr(e.offset>>>0)}}catch(t){Y("status","解析 ACK 失败：".concat(t.message))}}async function to(){let t=JSON.stringify({cmd:"meta",size:Q});await M.interconnect.sendQAICMessage(U,t),ta({type:"meta"})}async function ti(t){let e=Math.max(0,t/65536*1e3-(Date.now()-q));e>0&&await new Promise(t=>setTimeout(t,e)),q=Date.now()}async function tr(t){if(!K)throw Error("compiledBuffer 为空");if((t>>>=0)>=Q)return void await M.interconnect.sendQAICMessage(U,JSON.stringify({cmd:"done"}));let e=Math.min(J>>>0,Q-t>>>0),n=K.subarray(t,t+e),o=function(t){let e=0xffffffff;for(let n=0;n<t.length;n++){e^=t[n];for(let t=0;t<8;t++)e=e>>>1^0xedb88320&-(1&e)}return~e>>>0}(n),i=function(t){let e="",n=0,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";for(;n<t.length;){var i,r,a;let l=null!=(i=t[n++])?i:0,s=null!=(r=t[n++])?r:NaN,c=null!=(a=t[n++])?a:NaN,u=l>>2,f=(3&l)<<4|(s||0)>>4,d=(15&s)<<2|(c||0)>>6,v=63&(c||0);e+=o[u]+o[f]+(isNaN(s)?"=":o[d])+(isNaN(c)?"=":o[v])}return e}(n),r=JSON.stringify({cmd:"chunk",offset:t,total:Q>>>0,crc:o,data_b64:i});if(r.length>7e3&&J>512){let e=J;return J=Math.max(512,Math.floor(J/2)),console.log("[SEND] payload=%d 降分片 %d→%d",r.length,e,J),tr(t)}try{await ti(e),await M.interconnect.sendQAICMessage(U,r),G={type:"chunk",offset:t,len:e,crc:o},ta(G)}catch(t){throw Y("status","发送失败：".concat(t.message)),t}}function ta(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;tl(),t&&(G=t),I=setTimeout(async()=>{if(_)if(++j<=3)if((null==G?void 0:G.type)==="chunk"){let t=J;J=Math.max(512,Math.floor(J/2)),Y("status","未收到 ACK，重试#".concat(j,"，分片 ").concat(t,"→").concat(J));try{await tr(G.offset)}catch(t){Y("status","重发失败：".concat(t.message)),_=!1}}else{Y("status","未收到 ACK，重发 meta（#".concat(j,"）…"));try{await to()}catch(t){Y("status","重发 meta 失败：".concat(t.message)),_=!1}}else Y("status","多次重试失败"),_=!1},5e3)}function tl(){I&&(clearTimeout(I),I=null)}function ts(){_=!1,Q=0,K=null,W="",tl(),j=0,J=4096}function tc(t){let e=[];for(let n=0;n<t.length;n++){let o=t.charCodeAt(n);if(o>=55296&&o<=56319&&n+1<t.length){let e=t.charCodeAt(++n);e>=56320&&e<=57343?o=(o-55296<<10)+(e-56320)+65536:n--}o<=127?e.push(o):(o<=2047?e.push(192|o>>6):(o<=65535?e.push(224|o>>12):(e.push(240|o>>18),e.push(128|o>>12&63)),e.push(128|o>>6&63)),e.push(128|63&o))}return Uint8Array.from(e)}M.lifecycle.onLoad(()=>{t=[{node_id:"pickBtn",visibility:!0,disabled:!1,content:{type:"Button",value:{primary:!0,text:"选择 .txt 文件",callback_fun_id:H}}},{node_id:"sendBtn",visibility:!0,disabled:!1,content:{type:"Button",value:{primary:!0,text:"发送文件",callback_fun_id:X}}},{node_id:"status",visibility:!0,disabled:!1,content:{type:"Text",value:"就绪，等待发送"}}],M.ui.updatePluginSettingsUI(t),Z()})})();
//# sourceMappingURL=main.js.map